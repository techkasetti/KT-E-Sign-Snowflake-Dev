CREATE OR REPLACE PROCEDURE DOCGEN.UPSERT_USER_PROFILE(user_ref STRING, profile_data VARIANT)
RETURNS VARIANT
LANGUAGE SQL
AS
$$
MERGE INTO DOCGEN.USER_PROFILES t USING (SELECT :user_ref AS ur, :profile_data AS pd) s ON t.USER_REF = s.ur WHEN MATCHED THEN UPDATE SET PROFILE_DATA = s.pd, UPDATED_AT = CURRENT_TIMESTAMP() WHEN NOT MATCHED THEN INSERT (USER_REF, PROFILE_DATA) VALUES (s.ur, s.pd);
$$

