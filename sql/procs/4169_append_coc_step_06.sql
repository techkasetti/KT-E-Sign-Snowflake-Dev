CREATE OR REPLACE PROCEDURE DOCGEN.APPEND_COC_STEP_06(coc_id STRING, step VARIANT)
RETURNS VARIANT
LANGUAGE SQL
AS
$$
MERGE INTO DOCGEN.CHAIN_OF_CUSTODY_06 t USING (SELECT :coc_id AS cid) s ON t.COC_ID = s.cid WHEN MATCHED THEN UPDATE SET STEPS = ARRAY_CAT(COALESCE(STEPS, ARRAY_CONSTRUCT()), ARRAY_CONSTRUCT(:step)) WHEN NOT MATCHED THEN INSERT (COC_ID, STEPS) VALUES (s.cid, ARRAY_CONSTRUCT(:step));
$$

