CREATE OR REPLACE PROCEDURE DOCGEN.INCREMENT_BIOMETRIC_RETRY(subject_ref STRING)
RETURNS VARIANT
LANGUAGE SQL
AS
$$
MERGE INTO DOCGEN.BIOMETRIC_RETRIES t USING (SELECT :subject_ref AS sref) s ON t.SUBJECT_REF = s.sref WHEN MATCHED THEN UPDATE SET ATTEMPTS = ATTEMPTS + 1, LAST_ATTEMPT_AT = CURRENT_TIMESTAMP() WHEN NOT MATCHED THEN INSERT (RETRY_ID, SUBJECT_REF, ATTEMPTS, LAST_ATTEMPT_AT) VALUES (UUID_STRING(), s.sref, 1, CURRENT_TIMESTAMP());
$$

