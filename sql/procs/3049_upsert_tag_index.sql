CREATE OR REPLACE PROCEDURE DOCGEN.UPSERT_TAG_INDEX(tag STRING, template_ids ARRAY)
RETURNS VARIANT
LANGUAGE SQL
AS
$$
MERGE INTO DOCGEN.TAG_INDEX t USING (SELECT :tag AS tg, :template_ids AS tids) s ON t.TAG = s.tg WHEN MATCHED THEN UPDATE SET TEMPLATE_IDS = s.tids, UPDATED_AT = CURRENT_TIMESTAMP() WHEN NOT MATCHED THEN INSERT (IDX_ID, TAG, TEMPLATE_IDS) VALUES (UUID_STRING(), s.tg, s.tids);
$$

