CREATE OR REPLACE PROCEDURE DOCGEN.ARCHIVE_EXPIRED_SESSION_TOKENS()
RETURNS VARIANT
LANGUAGE SQL
AS
$$
INSERT INTO DOCGEN.USER_SESSION_TOKENS_ARCHIVE (TOKEN_ID, SESSION_ID, USER_REF, EXPIRED_AT)
SELECT TOKEN_ID, SESSION_ID, META:USER_REF::STRING, EXPIRES_AT FROM DOCGEN.SESSION_TOKENS WHERE EXPIRES_AT < CURRENT_TIMESTAMP();
DELETE FROM DOCGEN.SESSION_TOKENS WHERE EXPIRES_AT < CURRENT_TIMESTAMP();
$$
-- @1

