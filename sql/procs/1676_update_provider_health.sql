CREATE OR REPLACE PROCEDURE DOCGEN.UPDATE_PROVIDER_HEALTH(provider_id STRING, status STRING, details VARIANT)
RETURNS VARIANT
LANGUAGE SQL
AS
$$
MERGE INTO DOCGEN.PROVIDER_HEALTHCHECKS t USING (SELECT :provider_id AS pid, :status AS st, :details AS d) s ON t.PROVIDER_ID = s.pid WHEN MATCHED THEN UPDATE SET STATUS = s.st, DETAILS = s.d, LAST_CHECK = CURRENT_TIMESTAMP() WHEN NOT MATCHED THEN INSERT (HC_ID, PROVIDER_ID, STATUS, DETAILS) VALUES (UUID_STRING(), s.pid, s.st, s.d);
$$;

