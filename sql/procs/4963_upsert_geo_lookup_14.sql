CREATE OR REPLACE PROCEDURE DOCGEN.UPSERT_GEO_LOOKUP_14(geo_id STRING, ip_addr STRING, geo JSON)
RETURNS VARIANT
LANGUAGE SQL
AS
$$
MERGE INTO DOCGEN.GEO_LOOKUP_CACHE_14 t
USING (SELECT :geo_id AS gid, :ip_addr AS ip, :geo AS g) s
ON t.GEO_ID = s.gid
WHEN MATCHED THEN UPDATE SET IP_ADDR = s.ip, GEO = s.g, LOOKUP_AT = CURRENT_TIMESTAMP()
WHEN NOT MATCHED THEN INSERT (GEO_ID, IP_ADDR, GEO) VALUES (s.gid, s.ip, s.g);
$$

