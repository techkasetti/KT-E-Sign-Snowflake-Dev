CREATE OR REPLACE PROCEDURE DOCGEN.SET_PROVIDER_RATE_LIMIT(provider_id STRING, window_seconds INT, max_calls INT)
RETURNS VARIANT
LANGUAGE SQL
AS
$$
MERGE INTO DOCGEN.PROVIDER_RATE_LIMITS t USING (SELECT :provider_id AS pid, :window_seconds AS ws, :max_calls AS mc) s
ON t.PROVIDER_ID = s.pid
WHEN MATCHED THEN UPDATE SET WINDOW_SECONDS = s.ws, MAX_CALLS = s.mc
WHEN NOT MATCHED THEN INSERT (LIMIT_ID, PROVIDER_ID, WINDOW_SECONDS, MAX_CALLS) VALUES (UUID_STRING(), s.pid, s.ws, s.mc);
$$

