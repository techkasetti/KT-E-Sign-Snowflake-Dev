CREATE OR REPLACE PROCEDURE DOCGEN.INCREMENT_TEMPLATE_DAILY_USAGE(template_id STRING, day DATE, delta INT)
RETURNS VARIANT
LANGUAGE SQL
AS
$$
MERGE INTO DOCGEN.TEMPLATE_USAGE_DAILY t USING (SELECT :template_id AS tid, :day AS d, :delta AS dd) s ON t.TEMPLATE_ID = s.tid AND t.DAY = s.d
WHEN MATCHED THEN UPDATE SET USES = USES + s.dd
WHEN NOT MATCHED THEN INSERT (REC_ID, TEMPLATE_ID, DAY, USES) VALUES (UUID_STRING(), s.tid, s.d, s.dd);
$$;

