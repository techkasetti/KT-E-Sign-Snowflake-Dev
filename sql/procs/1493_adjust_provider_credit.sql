CREATE OR REPLACE PROCEDURE DOCGEN.ADJUST_PROVIDER_CREDIT(provider_id STRING, delta NUMBER)
RETURNS VARIANT
LANGUAGE SQL
AS
$$
MERGE INTO DOCGEN.PROVIDER_CREDITS t USING (SELECT :provider_id AS pid, :delta AS d) s ON t.PROVIDER_ID = s.pid
WHEN MATCHED THEN UPDATE SET BALANCE = BALANCE + s.d, UPDATED_AT = CURRENT_TIMESTAMP()
WHEN NOT MATCHED THEN INSERT (CREDIT_ID, PROVIDER_ID, BALANCE) VALUES (UUID_STRING(), s.pid, s.d);
$$;

