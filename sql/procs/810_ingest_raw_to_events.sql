-- STAGED -> MERGE ingestion procedure moving SIGNATURE_EVENTS_RAW into SIGNATURE_EVENTS using idempotent logic. @14 @31
CREATE OR REPLACE PROCEDURE DOCGEN.INGEST_RAW_TO_EVENTS()
RETURNS VARIANT
LANGUAGE SQL
AS
$$
  MERGE INTO DOCGEN.SIGNATURE_EVENTS tgt
  USING (SELECT RAW_JSON FROM DOCGEN.SIGNATURE_EVENTS_RAW) src
  ON tgt.EVENT_ID = src.RAW_JSON:EVENT_ID::STRING
  WHEN NOT MATCHED THEN INSERT (EVENT_ID, REQUEST_ID, DOCUMENT_ID, SIGNER_ID, ACCOUNT_ID, EVENT_TYPE, EVENT_PAYLOAD)
    VALUES (src.RAW_JSON:EVENT_ID::STRING, src.RAW_JSON:REQUEST_ID::STRING, src.RAW_JSON:DOCUMENT_ID::STRING, src.RAW_JSON:SIGNER_ID::STRING, src.RAW_JSON:ACCOUNT_ID::STRING, src.RAW_JSON:EVENT_TYPE::STRING, src.RAW_JSON);
  DELETE FROM DOCGEN.SIGNATURE_EVENTS_RAW WHERE TRUE;
  RETURN OBJECT_CONSTRUCT('status','ingested');
$$;

