Purpose: Cleanup helper SQL to archive old evidence bundles to Glacier-like storage (demonstration) and record lifecycle events. @70 @113
USE DATABASE AI_FEATURE_HUB;
USE SCHEMA DOCGEN;
CREATE OR REPLACE PROCEDURE DOCGEN.ARCHIVE_OLD_EVIDENCE(retention_days NUMBER)
RETURNS STRING
LANGUAGE SQL
AS
$$
INSERT INTO DOCGEN.PURGE_AUDIT (PURGE_ID, ENTITY_NAME, ROWS_PURGED, CUT_OFF, EXECUTED_AT)
SELECT 'archive_' || LEFT(GENERATE_UUID(),8), 'EVIDENCE_BUNDLE', COUNT(*), DATEADD('day', -retention_days, CURRENT_TIMESTAMP()), CURRENT_TIMESTAMP()
FROM DOCGEN.EVIDENCE_BUNDLE WHERE CREATED_AT <= DATEADD('day', -retention_days, CURRENT_TIMESTAMP());
DELETE FROM DOCGEN.EVIDENCE_BUNDLE WHERE CREATED_AT <= DATEADD('day', -retention_days, CURRENT_TIMESTAMP());
RETURN 'archive_done';
$$;

