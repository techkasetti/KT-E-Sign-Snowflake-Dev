USE DATABASE AI_FEATURE_HUB;
USE SCHEMA DOCGEN;

-- Materialized view: per-account daily signature summary
CREATE OR REPLACE MATERIALIZED VIEW DOCGEN.MV_DAILY_SIGNATURE_SUMMARY
AS
SELECT
  ACCOUNT_ID,
  CAST(EVENT_TS::DATE AS DATE) AS event_date,
  COUNT(*) AS events_count,
  COUNT(DISTINCT REQUEST_ID) AS requests_count
FROM DOCGEN.SIGNATURE_EVENTS
GROUP BY ACCOUNT_ID, CAST(EVENT_TS::DATE AS DATE);

-- View: flagged validations (anomalies)
CREATE OR REPLACE VIEW DOCGEN.VW_FLAGGED_VALIDATIONS AS
SELECT v.VALIDATION_ID, v.REQUEST_ID, v.SIGNER_ID, v.VALIDATION_STATUS, v.VERIFIED_AT, s.ACCOUNT_ID
FROM DOCGEN.SIGNATURE_VALIDATION v
JOIN DOCGEN.SIGNATURE_REQUESTS s ON v.REQUEST_ID = s.REQUEST_ID
WHERE v.META:anomaly = true;

